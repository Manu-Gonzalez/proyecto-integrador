 s=o?.boundNameRead,a=o?.boundNameAssign,l=o?.argName,c=o?.contextualArgumentInfo,d=o?.unevaluated??!1,h=o?.isLambdaCall??!1,g=o?.isLetVar??!1,m=o?.letProps;return{kind:"ReplacementNode",key:++u,label:e,nodeKind:t,precedence:n,value:i,children:r,childFrame:void 0,boundNameRead:s,boundNameAssign:a,argName:l,contextualArgumentInfo:c,unevaluated:d,isLambdaCall:h,isLetVar:g,letProps:m,introducesError:f(i)&&void 0===s&&!r.some(v),hasChildren:b}}function h(e){return"ReplacementNode"===e.kind?e:d(e.label,e.nodeKind,void 0,e.value,g)}const g=[],m=e=>"ReplacementNode"===e.kind;t.isOperLikeReplacement=e=>"string"!=typeof e.kind||e.kind===s.Range||e.kind===s.Array,t.isOperReplacement=e=>"string"!=typeof e.kind;const p=e=>void 0===e?g:[e],f=e=>(0,t.isOperReplacement)(e)&&i.util.isErrorOper(e),v=({value:e})=>f(e);function b(){return this.children.length>0}const y=(e,t)=>t?.kind===i.value.OperKind.Number?e.toNumber(t):void 0;function S(e,t,n,i,r){const s=t.getFunctionSignature(n),a=(0,o.getActiveParameterIndex)(n,i,r),[l,c]=s.parameters[a].label;return`${e.getWorksheetFuncName(n)}:${s.label.substring(l,c)}`}const C={[i.signature.OperatorId.Concat]:1,[i.signature.OperatorId.Add]:2,[i.signature.OperatorId.Sub]:2,[i.signature.OperatorId.Mul]:3,[i.signature.OperatorId.Div]:3,[i.signature.OperatorId.Pow]:4,[i.signature.OperatorId.Percent]:5,[i.signature.OperatorId.Pos]:6,[i.signature.OperatorId.Neg]:6,[i.signature.OperatorId.Union]:7,[i.signature.OperatorId.Isect]:9,[i.signature.OperatorId.Range]:10};class _{constructor(e,t,n,i){this.globals=e,this.frame=t,this.formula=n,this.lambdaFinder=i,this.capturedValues=new Map,this.compressOperators=e.options.compressOperators,this.compressLetVars=e.options.compressLetVars;for(const{label:e,value:n}of t.entrypointLocalValues)this.capturedValues.set(e,n);this.funcHost=(0,o.getFunctionInformationHost)(e.locale)}getValue(e){return this.frame.lexicalValues.get(e)?.value}literalNode(e,n,r){const o=this.getValue(r);return void 0===o?d(r,i.formula.NodeKind.Literal,void 0,t.copyReplacement,g,{unevaluated:!0}):function(e,t,n){return{kind:"WeakReplacementNode",label:e,nodeKind:t,value:n}}(r,i.formula.NodeKind.Literal,o)}arrayNode(e,n,r){const o=this.getValue(r);if(void 0===o)return d(r,i.formula.NodeKind.Array,void 0,t.copyReplacement,g,{unevaluated:!0});const s=(new Array).concat(...e).filter(m);return s.every((e=>e.nodeKind===i.formula.NodeKind.Literal))?d(r,i.formula.NodeKind.Array,void 0,o,[]):d(r,i.formula.NodeKind.Array,void 0,o,s)}appNode(e,n,a,l){const c=this.getValue(l);if(void 0===c)return d(l,i.formula.NodeKind.App,void 0,t.copyReplacement,g,{unevaluated:!0});if(e.kind===i.formula.NodeKind.Operator){switch(e.id){case i.signature.OperatorId.At:case i.signature.OperatorId.Pound:if(1===n.length&&n[0].nodeKind===i.formula.NodeKind.CellRef)return d(l,i.formula.NodeKind.App,void 0,c,g)}const t=n.filter(m),r=C[e.id];if(void 0!==r&&this.compressOperators){const e=(new Array).concat(...t.map((e=>e.precedence!==r||e.introducesError?[e]:e.children)));return d(l,i.formula.NodeKind.App,r,c,e)}return d(l,i.formula.NodeKind.App,r,c,t)}if(e.kind===i.formula.NodeKind.WSF){const a=e.id,u=this.funcHost.getFunctionSignature(a),m=[d(e.label,i.formula.NodeKind.WSF,void 0,{kind:s.WSF,id:a},g),...n.map(h).map(((e,t)=>{const s=e.value;let l,c;switch(s.kind){case i.value.OperKind.Number:case i.value.OperKind.Boolean:case i.value.OperKind.String:l=this.funcHost.getPositionalInfo(a,t,n.length,s)}if(void 0!==u){const e=(0,o.getActiveParameterIndex)(a,t,n.length),[i,r]=u.parameters[e].label;c=u.label.substring(i,r)}return(0,r.assert)(null==e.contextualArgumentInfo&&null==e.argName),null!=l||null!=c?{...e,argName:c,contextualArgumentInfo:l}:e}))];return function({locale:e,mathpack:n},r,o,a){if(o===i.signature.WorksheetFuncId.VLOOKUP||o===i.signature.WorksheetFuncId.HLOOKUP){const l=a[2],c=a[3],u=y(n,c?.value);if(l&&(0,t.isOperLikeReplacement)(l.value)&&void 0!==u&&Number.isInteger(u)&&u>=1){const n=(0,t.isOperReplacement)(l.value)?l.value:l.value.oper,c=S(e,r,o,2,a.length-1);if(n.kind===i.value.OperKind.Range&&i.util.isSheetIndex(n.sheets)&&1===n.ranges.length){const e=n.ranges[0],t={kind:s.Range,oper:n,columnsOfInterest:o===i.signature.WorksheetFuncId.VLOOKUP&&u<=e.cols?[{index:e.col+u-1,label:c}]:void 0,rowsOfInterest:o===i.signature.WorksheetFuncId.HLOOKUP&&u<=e.rows?[{index:e.row+u-1,label:c}]:void 0};a[2]={...l,value:t}}else if(n.kind===i.value.OperKind.Array){const e=n,t={kind:s.Array,oper:n,columnsOfInterest:o===i.signature.WorksheetFuncId.VLOOKUP&&u<=e.cols?[{index:u-1,label:c}]:void 0,rowsOfInterest:o===i.signature.WorksheetFuncId.HLOOKUP&&u<=e.rows?[{index:u-1,label:c}]:void 0};a[2]={...l,value:t}}}}if(o===i.signature.WorksheetFuncId.INDEX){const[l,c,u,d,h]=a,g=y(n,u?.value),m=y(n,d?.value),p=y(n,h?.value);if(c&&(0,t.isOperLikeReplacement)(c.value)&&void 0!==g&&Number.isInteger(g)&&g>=0&&(void 0===m||Number.isInteger(m)&&m>=0)&&(void 0===p||Number.isInteger(p)&&p>=1)){const n=(0,t.isOperReplacement)(c.value)?c.value:c.value.oper,l=S(e,r,o,1,a.length-1),u=S(e,r,o,2,a.length-1);if(n.kind===i.value.OperKind.Range&&i.util.isSheetIndex(n.sheets)&&1===n.ranges.length&&(void 0===p||1===p)){const e=n.ranges[0];let t=-1,i=-1,r="",o="";void 0===m?1===e.rows?(t=g-1,r=l):1===e.cols&&(i=g-1,o=l):(i=g-1,o=l,t=m-1,r=u);const d={kind:s.Range,oper:n,columnsOfInterest:t>=0&&t<e.cols?[{index:e.col+t,label:r}]:void 0,rowsOfInterest:i>=0&&i<e.rows?[{index:e.row+i,label:o}]:void 0};a[1]={...c,value:d}}if(n.ki